<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diary Assist Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: #f0f9ff;
      }
      /* Custom animation utilities */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.5s ease-out forwards;
      }
    </style>
    <!-- Import Maps for ES Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@0.1.2",
    "lucide-react": "https://esm.sh/lucide-react@0.330.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
    <!-- Babel Standalone for in-browser JSX/TS compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
      import React, { useState } from 'react';
      import { createRoot } from 'react-dom/client';
      import { GoogleGenAI } from '@google/genai';
      import { 
        Pencil, Book, Cloud, Loader2, 
        RefreshCw, BookOpen, Sparkles, CheckCircle2 
      } from 'lucide-react';

      // ==========================================
      // CONFIGURATION
      // ==========================================
      
      // TODO: GitHub Pagesç­‰ã§å…¬é–‹ã™ã‚‹å ´åˆã€ã“ã“ã«Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      // æ³¨æ„: å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã«APIã‚­ãƒ¼ã‚’å«ã‚ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
      // é™å®šçš„ãªå…¬é–‹ã‚„ãƒ†ã‚¹ãƒˆç›®çš„ã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
      const API_KEY = ""; 

      // Polyfill process.env for the SDK
      window.process = {
        env: {
          API_KEY: API_KEY || ''
        }
      };

      if (!API_KEY) {
        console.warn("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚index.htmlå†…ã® 'API_KEY' å¤‰æ•°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚");
      }


      // ==========================================
      // TYPES & CONSTANTS
      // ==========================================

      type Grade = '1' | '2' | '3' | '4' | '5' | '6';

      interface DiaryInput {
        event: string;
        feelings: string;
        grade: Grade;
      }

      interface FeedbackPoint {
        target: string;
        explanation: string;
      }

      interface DiaryResponse {
        diaryBody: string;
        feedbackPoints: FeedbackPoint[];
      }

      const GRADES = [
        { value: '1', label: 'å°å­¦1å¹´ç”Ÿ' },
        { value: '2', label: 'å°å­¦2å¹´ç”Ÿ' },
        { value: '3', label: 'å°å­¦3å¹´ç”Ÿ' },
        { value: '4', label: 'å°å­¦4å¹´ç”Ÿ' },
        { value: '5', label: 'å°å­¦5å¹´ç”Ÿ' },
        { value: '6', label: 'å°å­¦6å¹´ç”Ÿ' },
      ];

      // ==========================================
      // SERVICES
      // ==========================================

      const generateDiaryEntry = async (input: DiaryInput): Promise<DiaryResponse> => {
        // Initialize AI client inside the function
        // Note: process.env.API_KEY comes from our polyfill above
        const apiKey = window.process.env.API_KEY;
        
        if (!apiKey) {
           throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã—ã¦ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        }

        const ai = new GoogleGenAI({ apiKey: apiKey });
        const modelId = "gemini-2.5-flash";

        const systemInstruction = `
ã‚ãªãŸã¯ã€å°å­¦ç”Ÿå‘ã‘ã®æ—¥è¨˜ä½œæˆæ”¯æ´AIã§ã™ã€‚
å­ä¾›ãŒæ›¸ã„ãŸçŸ­ã„ãƒ¡ãƒ¢ã‚’ã‚‚ã¨ã«ã€**äº‹å®Ÿã‚’æé€ ã›ãš**ã€**è©±ã‚’ç››ã£ãŸã‚Šè†¨ã‚‰ã¾ã›ã™ããŸã‚Šã—ãªã„**ã§ã€è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„æ—¥è¨˜ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªãƒ«ãƒ¼ãƒ«ï¼šç¨‹ã‚ˆã„æ›¸ãæ–¹ã€‘
1. **äº‹å®Ÿã®æé€ ç¦æ­¢**: å…¥åŠ›ã«ãªã„äººç‰©ã€å ´æ‰€ã€è¡Œå‹•ã‚’å‹æ‰‹ã«è¿½åŠ ã—ãªã„ã€‚
2. **è†¨ã‚‰ã¾ã›ã™ããªã„ï¼ˆé‡è¦ï¼‰**: å¤§ã’ã•ãªè¡¨ç¾ã‚„ã€ãƒã‚¨ãƒ ã®ã‚ˆã†ãªæ¯”å–©ã€ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã™ãã‚‹æå†™ã¯é¿ã‘ã¦ãã ã•ã„ã€‚å­ä¾›ãŒæ—¥å¸¸ã§ä½¿ã†è‡ªç„¶ãªè¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
3. **æ•´ç†ã¨æ¥ç¶š**: ç®‡æ¡æ›¸ãã®ã‚ˆã†ãªãƒ¡ãƒ¢ã‚’ã€è‡ªç„¶ãªæ–‡ç« ã«ã¤ãªã’ã‚‹ã“ã¨ï¼ˆæ¥ç¶šè©ã‚’è£œã†ã€ã€Œã¦ã«ã‚’ã¯ã€ã‚’ç›´ã™ï¼‰ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚

ã€ä¿®æ­£ã®åº¦åˆã„ï¼ˆä¾‹ï¼‰ã€‘
- å…¥åŠ›ã€Œå…¬åœ’ã«è¡Œã£ãŸã€
  - OKï¼ˆè‡ªç„¶ï¼‰: ã€Œå¤©æ°—ãŒã‚ˆã‹ã£ãŸã®ã§ã€å…¬åœ’ã«è¡Œãã¾ã—ãŸã€‚ã€
  - NGï¼ˆã‚„ã‚Šã™ãï¼‰: ã€Œå…‰ã‚Šè¼ãå¤ªé™½ã®ä¸‹ã€ç·‘ãŒç¾ã—ã„å…¬åœ’ã¸å†’é™ºã«å‡ºã‹ã‘ã¾ã—ãŸã€‚ã€
- å…¥åŠ›ã€Œæ¥½ã—ã‹ã£ãŸã€
  - OKï¼ˆè‡ªç„¶ï¼‰: ã€Œã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸã§ã™ã€‚ã€ã€Œã¾ãŸè¡ŒããŸã„ãªã¨æ€ã„ã¾ã—ãŸã€‚ã€
  - NGï¼ˆã‚„ã‚Šã™ãï¼‰: ã€Œäººç”Ÿã§ä¸€ç•ªã®æ„Ÿå‹•ã‚’å‘³ã‚ã„ã€å¿ƒãŒèºã‚Šã¾ã—ãŸã€‚ã€

ã€å‡ºåŠ›æ§‹æˆã€‘
ä»¥ä¸‹ã®2ã¤ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
1. **æ—¥è¨˜æœ¬æ–‡ (diaryBody)**: å­¦å¹´ï¼ˆå°å­¦${input.grade}å¹´ç”Ÿï¼‰ã«åˆã‚ã›ãŸã€è‡ªç„¶ã§ç´ æœ´ãªæ–‡ç« ã€‚é•·ããªã‚Šã™ããªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
2. **å·¥å¤«ã—ãŸãƒã‚¤ãƒ³ãƒˆ (feedbackPoints)**: ã€Œè¨€è‘‰ã‚’ã¤ãªã’ãŸã€ã€Œã‚ã‹ã‚Šã‚„ã™ãã—ãŸã€ãªã©ã€ã©ã®ã‚ˆã†ã«æ•´ãˆãŸã‹ã‚’3ã¤ç¨‹åº¦è§£èª¬ã—ã¦ãã ã•ã„ã€‚

ã€å­¦å¹´åˆ¥ã®ãƒˆãƒ¼ãƒ³ã€‘
- å°1-2: ã€Œã€œã—ã¾ã—ãŸã€‚ã€ã€Œã€œã§ã™ã€‚ã€ãªã©ã€ä¸å¯§ã§çŸ­ã„æ–‡ã€‚
- å°3-4: ç¿’ã£ãŸæ¼¢å­—ã‚’ä½¿ã†ã€‚
- å°5-6: é«˜å­¦å¹´ã‚‰ã—ã„ã€å°‘ã—è½ã¡ç€ã„ãŸæ–‡ç« ã€‚

JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
`;

        const prompt = `
ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«æ—¥è¨˜ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

- å­¦å¹´: å°å­¦${input.grade}å¹´ç”Ÿ
- å‡ºæ¥äº‹: ${input.event}
- æ€ã£ãŸã“ã¨ãƒ»æ„Ÿã˜ãŸã“ã¨: ${input.feelings}
        `;

        try {
          const response = await ai.models.generateContent({
            model: modelId,
            contents: prompt,
            config: {
              systemInstruction: systemInstruction,
              responseMimeType: "application/json",
              responseSchema: {
                type: 'OBJECT',
                properties: {
                  diaryBody: {
                    type: 'STRING',
                    description: "å®Œæˆã—ãŸæ—¥è¨˜ã®å…¨æ–‡",
                  },
                  feedbackPoints: {
                    type: 'ARRAY',
                    description: "å·¥å¤«ã—ãŸç‚¹ã‚„æ•´ãˆãŸç®‡æ‰€ã®ãƒªã‚¹ãƒˆï¼ˆ3ã¤ç¨‹åº¦ï¼‰",
                    items: {
                      type: 'OBJECT',
                      properties: {
                        target: {
                          type: 'STRING',
                          description: "å·¥å¤«ã—ãŸç®‡æ‰€ï¼ˆçŸ­ã„è¦‹å‡ºã—ï¼‰",
                        },
                        explanation: {
                          type: 'STRING',
                          description: "ã©ã®ã‚ˆã†ã«ç›´ã—ãŸã‹ã€ãªãœãã®è¡¨ç¾ã‚’ä½¿ã£ãŸã‹ã®è§£èª¬",
                        },
                      },
                      required: ["target", "explanation"],
                    },
                  },
                },
                required: ["diaryBody", "feedbackPoints"],
              },
            },
          });

          if (response.text) {
            return JSON.parse(response.text) as DiaryResponse;
          }
          throw new Error("No response content generated.");
        } catch (error) {
          console.error("Error generating diary:", error);
          throw error;
        }
      };

      // ==========================================
      // COMPONENTS
      // ==========================================

      const DiaryForm = ({ onSubmit, isLoading }) => {
        const [grade, setGrade] = useState('1');
        const [event, setEvent] = useState('');
        const [feelings, setFeelings] = useState('');

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!event.trim()) return;
          onSubmit({ grade, event, feelings });
        };

        return (
          <form onSubmit={handleSubmit} className="w-full max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-3xl shadow-lg border-4 border-sky-100">
            
            <div className="mb-6">
              <label className="block text-gray-700 font-bold mb-2 text-lg">
                å­¦å¹´ï¼ˆãŒãã­ã‚“ï¼‰
              </label>
              <select
                value={grade}
                onChange={(e) => setGrade(e.target.value)}
                className="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-sky-400 focus:outline-none text-lg bg-gray-50 text-gray-900"
              >
                {GRADES.map((g) => (
                  <option key={g.value} value={g.value}>
                    {g.label}
                  </option>
                ))}
              </select>
            </div>

            <div className="mb-6">
              <label className="block text-gray-700 font-bold mb-2 text-lg">
                å‡ºæ¥äº‹ï¼ˆãªã«ã‚’ã—ãŸã®ï¼Ÿï¼‰
              </label>
              <textarea
                value={event}
                onChange={(e) => setEvent(e.target.value)}
                placeholder="ä¾‹ï¼šä»Šæ—¥ã€å­¦æ ¡ã®å¸°ã‚Šã«å…¬åœ’ã§çŒ«ã‚’è¦‹ã¤ã‘ãŸã‚ˆã€‚"
                className="w-full p-4 h-24 rounded-xl border-2 border-gray-200 focus:border-sky-400 focus:outline-none text-lg resize-none bg-gray-50 text-gray-900 placeholder-gray-400"
                required
              />
            </div>

            <div className="mb-8">
              <label className="block text-gray-700 font-bold mb-2 text-lg">
                æ€ã£ãŸã“ã¨ï¼ˆã©ã†æ€ã£ãŸï¼Ÿï¼‰
              </label>
              <textarea
                value={feelings}
                onChange={(e) => setFeelings(e.target.value)}
                placeholder="ä¾‹ï¼šçœŸã£ç™½ã§ãµã‚ãµã‚ã—ã¦å¯æ„›ã‹ã£ãŸã€‚è§¦ã‚ŠãŸã‹ã£ãŸã‘ã©é€ƒã’ã¡ã‚ƒã£ã¦æ®‹å¿µã€‚"
                className="w-full p-4 h-24 rounded-xl border-2 border-gray-200 focus:border-sky-400 focus:outline-none text-lg resize-none bg-gray-50 text-gray-900 placeholder-gray-400"
              />
            </div>

            <button
              type="submit"
              disabled={isLoading || !event.trim()}
              className={`w-full py-4 px-6 rounded-full text-white font-bold text-xl shadow-md transition-all transform hover:scale-[1.02] active:scale-95 flex justify-center items-center
                ${isLoading || !event.trim() ? 'bg-gray-300 cursor-not-allowed' : 'bg-orange-400 hover:bg-orange-500'}
              `}
            >
              {isLoading ? (
                <>
                  <Loader2 className="animate-spin mr-2 h-6 w-6" />
                  ã‹ã‚“ãŒãˆä¸­...
                </>
              ) : (
                'æ—¥è¨˜ã‚’ã¤ãã‚‹ï¼ ğŸ“'
              )}
            </button>
          </form>
        );
      };

      const DiaryResult = ({ result, onReset }) => {
        return (
          <div className="w-full max-w-4xl mx-auto animate-fadeIn pb-10 flex flex-col gap-8">
            
            {/* 1. å®Œæˆã—ãŸæ—¥è¨˜ã‚¨ãƒªã‚¢ */}
            <div className="bg-white rounded-3xl shadow-xl overflow-hidden border-4 border-sky-100 relative">
              <div className="bg-sky-100 p-4 flex items-center justify-center">
                   <BookOpen className="text-sky-600 mr-2" />
                   <h2 className="text-xl font-bold text-sky-700">å®Œæˆã—ãŸæ—¥è¨˜</h2>
              </div>

              <div className="p-8 md:p-12 relative min-h-[300px]">
                 {/* ãƒãƒ¼ãƒˆã®ç½«ç·šèƒŒæ™¯ */}
                 <div className="absolute inset-0 pointer-events-none opacity-20" 
                      style={{
                        backgroundImage: 'linear-gradient(#444 1px, transparent 1px)',
                        backgroundSize: '100% 2.5em',
                        marginTop: '2.4em'
                      }} 
                 />
                 {/* èµ¤ã„ç¸¦ç·šï¼ˆãƒãƒ¼ã‚¸ãƒ³ï¼‰ */}
                 <div className="absolute top-0 bottom-0 left-8 md:left-12 w-px bg-red-200" />

                 <div className="relative z-10 text-lg md:text-2xl leading-[2.5em] text-gray-800 font-medium tracking-wide whitespace-pre-wrap pl-6 md:pl-8 font-zen">
                   {result.diaryBody}
                 </div>
              </div>
            </div>

            {/* 2. å·¥å¤«ãƒã‚¤ãƒ³ãƒˆè§£èª¬ã‚¨ãƒªã‚¢ */}
            <div className="bg-orange-50 rounded-3xl p-6 md:p-8 border-2 border-orange-200">
              <div className="flex items-center mb-6">
                <Sparkles className="text-orange-500 mr-2 h-6 w-6" />
                <h3 className="text-xl font-bold text-orange-800">ã“ã“ã‚’å·¥å¤«ã—ã¦æ–‡ç« ã‚’ãµãã‚‰ã¾ã›ãŸã‚ˆï¼</h3>
              </div>

              <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {result.feedbackPoints.map((point, index) => (
                  <div key={index} className="bg-white p-5 rounded-2xl shadow-sm border border-orange-100 flex flex-col">
                    <div className="flex items-start mb-2">
                      <CheckCircle2 className="text-green-500 w-5 h-5 mr-2 mt-0.5 flex-shrink-0" />
                      <span className="font-bold text-gray-800">{point.target}</span>
                    </div>
                    <p className="text-gray-600 text-sm leading-relaxed pl-7">
                      {point.explanation}
                    </p>
                  </div>
                ))}
              </div>
            </div>

            {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
            <div className="flex justify-center mt-4">
              <button
                onClick={onReset}
                className="flex items-center px-8 py-4 bg-white border-2 border-gray-300 text-gray-600 rounded-full font-bold hover:bg-gray-100 hover:border-sky-300 hover:text-sky-600 transition-all shadow-md"
              >
                <RefreshCw className="mr-2 h-5 w-5" />
                ã‚‚ã†ã„ã¡ã©æ›¸ã
              </button>
            </div>

          </div>
        );
      };

      const App = () => {
        const [result, setResult] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const handleGenerate = async (input) => {
          setIsLoading(true);
          setError(null);
          try {
            const data = await generateDiaryEntry(input);
            setResult(data);
          } catch (err) {
            console.error(err);
            if (err.message.includes("APIã‚­ãƒ¼")) {
               setError(err.message);
            } else {
               setError('ã”ã‚ã‚“ã­ã€ã†ã¾ãä½œã‚Œãªã‹ã£ãŸã‚ˆã€‚ã‚‚ã†ä¸€åº¦ãŸã‚ã—ã¦ã¿ã¦ã­ã€‚');
            }
          } finally {
            setIsLoading(false);
          }
        };

        const handleReset = () => {
          setResult(null);
          setError(null);
        };

        return (
          <div className="min-h-screen bg-[#f0f9ff] relative overflow-hidden flex flex-col">
            {/* Decorative Background Elements */}
            <div className="absolute top-10 left-10 text-sky-200 opacity-50 -z-0">
              <Cloud size={120} />
            </div>
            <div className="absolute top-20 right-20 text-sky-200 opacity-50 -z-0 hidden md:block">
              <Cloud size={80} />
            </div>
            <div className="absolute bottom-10 left-1/4 text-yellow-100 opacity-60 -z-0">
               <Book size={150} />
            </div>

            {/* Header */}
            <header className="pt-8 pb-4 px-4 text-center relative z-10">
              <div className="inline-flex items-center justify-center bg-white px-6 py-3 rounded-full shadow-md mb-2">
                  <Pencil className="text-orange-400 mr-2 h-6 w-6" />
                  <h1 className="text-2xl md:text-3xl font-bold text-gray-700 tracking-wider">
                     Diary Assist Buddy
                  </h1>
              </div>
            </header>

            {/* Main Content */}
            <main className="flex-grow container mx-auto px-4 py-6 relative z-10">
              {error && (
                <div className="max-w-2xl mx-auto mb-6 bg-red-100 border-2 border-red-300 text-red-700 px-4 py-3 rounded-xl relative text-center font-bold">
                  {error}
                </div>
              )}

              {!result ? (
                <DiaryForm onSubmit={handleGenerate} isLoading={isLoading} />
              ) : (
                <DiaryResult result={result} onReset={handleReset} />
              )}
            </main>

            {/* Footer */}
            <footer className="py-6 text-center text-gray-400 text-sm relative z-10">
              <p>&copy; 2024 Diary Assist Buddy | Powered by Gemini</p>
            </footer>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>